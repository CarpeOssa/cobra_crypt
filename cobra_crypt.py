import os
import sys
import base64
import hashlib
from cryptography.fernet import Fernet
from getpass import getpass
import random

# COBRA-style stealth prefix and custom COBRA character suffixes
STEALTH_PREFIX = ".cobra_"
CODENAME_SUFFIXES = [
    "destro", "major_blud", "barroness", "serpentor", "cobra_commander",
    "zartan", "xamot", "tomax", "firefly", "wild_weasle",
    "dr_mindbender", "dr_venom", "billy", "stormshadow"
]

ASCII_COBRA_LOGO = r'''
▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄ 
▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
▐░█▀▀▀▀▀▀▀▀▀ ▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀█░▌
▐░▌          ▐░▌       ▐░▌▐░▌       ▐░▌▐░▌       ▐░▌▐░▌       ▐░▌
▐░▌          ▐░▌       ▐░▌▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌
▐░▌          ▐░▌       ▐░▌▐░░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
▐░▌          ▐░▌       ▐░▌▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀█░█▀▀ ▐░█▀▀▀▀▀▀▀█░▌
▐░▌          ▐░▌       ▐░▌▐░▌       ▐░▌▐░▌     ▐░▌  ▐░▌       ▐░▌
▐░█▄▄▄▄▄▄▄▄▄ ▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌▐░▌      ▐░▌ ▐░▌       ▐░▌
▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░▌ ▐░▌       ▐░▌▐░▌       ▐░▌
 ▀▀▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀▀   ▀         ▀  ▀         ▀ 
                                                                 
 ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄         ▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄ 
▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░▌       ▐░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
▐░█▀▀▀▀▀▀▀▀▀ ▐░█▀▀▀▀▀▀▀█░▌▐░▌       ▐░▌▐░█▀▀▀▀▀▀▀█░▌ ▀▀▀▀█░█▀▀▀▀ 
▐░▌          ▐░▌       ▐░▌▐░▌       ▐░▌▐░▌       ▐░▌     ▐░▌     
▐░▌          ▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄▄▄█░▌     ▐░▌     
▐░▌          ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌     ▐░▌     
▐░▌          ▐░█▀▀▀▀█░█▀▀  ▀▀▀▀█░█▀▀▀▀ ▐░█▀▀▀▀▀▀▀▀▀      ▐░▌     
▐░▌          ▐░▌     ▐░▌       ▐░▌     ▐░▌               ▐░▌     
▐░█▄▄▄▄▄▄▄▄▄ ▐░▌      ▐░▌      ▐░▌     ▐░▌               ▐░▌     
▐░░░░░░░░░░░▌▐░▌       ▐░▌     ▐░▌     ▐░▌               ▐░▌     
 ▀▀▀▀▀▀▀▀▀▀▀  ▀         ▀       ▀       ▀                 ▀            
'''

def derive_key(password):
    return base64.urlsafe_b64encode(hashlib.sha256(password.encode()).digest())

def generate_cobra_name(filename):
    base, ext = os.path.splitext(filename)
    suffix = random.choice(CODENAME_SUFFIXES)
    return f"{STEALTH_PREFIX}{base}_{suffix}{ext}"

def recover_original_name(filename):
    if filename.startswith(STEALTH_PREFIX):
        name = filename[len(STEALTH_PREFIX):]
        for suffix in CODENAME_SUFFIXES:
            tag = f"_{suffix}"
            if tag in name:
                return name.replace(tag, "")
    return filename

def encrypt_directory(path, password):
    key = derive_key(password)
    fernet = Fernet(key)

    for root, _, files in os.walk(path):
        for file in files:
            filepath = os.path.join(root, file)
            with open(filepath, 'rb') as f:
                data = f.read()
            encrypted = fernet.encrypt(data)
            with open(filepath, 'wb') as f:
                f.write(encrypted)
            cobra_name = generate_cobra_name(file)
            os.rename(filepath, os.path.join(root, cobra_name))

    print("\n Files encrypted. Surveillance evaded. HAIL COBRA! ")

def decrypt_directory(path, password):
    key = derive_key(password)
    fernet = Fernet(key)

    for root, _, files in os.walk(path):
        for file in files:
            if not file.startswith(STEALTH_PREFIX):
                continue
            filepath = os.path.join(root, file)
            with open(filepath, 'rb') as f:
                encrypted = f.read()
            try:
                data = fernet.decrypt(encrypted)
            except Exception as e:
                print(f" Error decrypting {file}: {e}")
                continue
            with open(filepath, 'wb') as f:
                f.write(data)
            original_name = recover_original_name(file)
            os.rename(filepath, os.path.join(root, original_name))

    print("\n Decryption complete. Operative safe. COBRA prevails.")

def print_help():
    print(ASCII_COBRA_LOGO)
    print("""
COBRA Crypt™ - For Eyes Only

Encrypt and cloak your files from the prying eyes of G.I. Joe operatives.
When privacy is power... trust in COBRA.

Usage:
  python cobra_crypt.py encrypt <directory>
  python cobra_crypt.py decrypt <directory>

Options:
  encrypt       Encrypt and stealth cloak all files in a directory
  decrypt       Decrypt and restore original file names

Examples:
  python cobra_crypt.py encrypt ~/COBRA/intel
  python cobra_crypt.py decrypt ~/COBRA/intel

Quick Tip:
  Use strong, unforgettable passwords. If compromised, your data could fall into G.I. Joe hands!
""")

if __name__ == '__main__':
    print(ASCII_COBRA_LOGO)

    if len(sys.argv) == 2 and sys.argv[1] == 'hail':
        print(r'''

#*@#*******************+:+++***+...............:::.....+-.-:.....=++=-....:-+***********************
**#*******==+**********-:::.***+-......................-=.+*:.....:.::.:::-*************************
##********+:::*********+--..:***=:.......=#*=----=+#......=+............::-*************************
***********::::********=-...-+++-......###+:..::::.==#=................::.-*************************
**:-+******+::::********-...:=**:....#+-=:..:.----::.+*#................::**********--**************
#*-:-*******=::.::+*****::...::..:..#*=**+=-+*######-:+#%................:==*****+-::-==************
**=:+@##+****-=-:%.:+***+-.........-*=****+::+*#####*+##*#.............+***.:::=-:::::::=***********
***-%::@=+**#*.%@%::****+:.........#:*##*##+-+*#####+*##*#.............++:..::::::..:::+************
***--@@@+*=%=+@@@---*%+**+-:-:.....+-#@@@@@++**###*#=@@@+=.......................::-:::+************
**#@@@@#@#*:#@@%::=*.%%+-****:....==*%@@@@@@@%##*#%@@@@@#:......................:::::--*************
*#@@@@%#%=-%@%@-:+*:%@@:.=***=....*:*@@@@@@@%%@@@@%@@@#@#+-...................+-:..:=********+***===
**@@@@@@+-@%#%.:#*:%%@:.+.=.......*=#@@@@@@@%+**..+@@%*@%+-..  ...............-:....::-**++*-.:.-:::
***#@@@@@@@##%##%-%%@-*@:@:......=**%@*%@@@@%*+=..*@%%-@%*=..  ....................::::::.:.:...-***
:-**#%%@@@@*@%@%.#%@*:@=%@.    ..#+%@%=+%@@@%*+-..#%##.@@+=..  ... .............-:--:::::=.:.:-+****
::-:*%%@@@@@@@%##%@#%%-#@@.    .*#@@@+-=#@@@%*+...#**=.@@*+        .............-:.:.:.....:-*******
-....-@@@@@@@@%%@@@@%@@%@..    .@@@@@-:=*@@@%#*..:*++::@@#*..      ...........=--:.:.:.....=+*******
=:.....%@@@@@@@@@@@%#+%@...    .*@@@@@:-+#@@@%#..-=+=.:@@@*....    ............:...:.........:+*****
**-:.::=%@@@@@@@@@@@%*@....      .@@@@@@==%@@@#.:==--@@@@@@..          .....................:++-****
**+=:#-%@@@@@@@@@@@@@%@........  ..:@@@@@@@%@@#:-+@@@@@@*..            ..............:+......:....:.
****%##@@@@@@@@%%@@@#%%%#####=...+##@@@@@@@@@@@@@@@@#..                  .......................:+++
-***%@%@@@@@@@@@@@@%@#%%#**+**#####*@@@@@@@@@@@@@@@%%#...                .............:......-+:****
::=+@@@@@@@@@@@@@@@@%#@*#%+*=+*####*+%@%@@@@@@@@@@@@=%*+.......          ............=*...-+********
:::-@%@@@@@@@@@@@@@@%%%**+@##++*#@%#*+*%%%*%@@@@%%#+*@*-+-.......        .........=*+::::-=-=:=+-:.:
+-+:@@@@@@@@@@@@@@@@@@%#%#*@@*++=-****+++#@@@@@@##***=--=#++##:.... .. ..  ............:.::........:
****@@@@@@@@@@@@@@@@@%@@%@#@@#+*===+*%#**+++*#%%*+-=======***#**+*-... ..  ............::......:..:.
-*+*%@@@@@%%@@@@@@@@@@@@@@@@@%%#+++=+++*+*+=========+=+*%%***+*#*+=+*....  ....................----+
...-*@@@@%%%@@%@@@@@@@@@@@@@@@@##*+++#++%%%%%%%%%%%%%%%%+++=+****+#*=#..   ..................:*+****
+..::+@@@@@%%%@@@@@@@@@@@@@@@@@@%#***++++++++++=======++====-=*****##+#...................:-********
=...::=@@@@%%%@@@@@@@@@@@@@@@@@@@%%##*#+=+=========---*****+-==*##%####+...................-***+::=+
-:..:...@@@@%%@@@@@@@@@@@@@@@@@@@@@%%%#==========-=-=--###+#===##%%#%%%#.......................::::.
*=:.......=@@@%@@@@@@@@@@@@@@@@@@@@@@@%#**++*+++===-======%%*++*%%##%@*#-........................:::
**+-:........+@@@@@@@@@@@@@@@@@@@@%@@@@@#%#****+=-==========#+*%#%%@@%*#*........................::-
-.:=**+........-@@@@@@@@@@@@@@@@@@@@*+*@#%+==+******+++*****##%%@@@@@%###........................:-+
....=+.-=.......+@@@@@@@@@@@@@@@@%###+*#@**++===+++===+=====+*#@@@@@@@*##-.......................-::
.................%@@@@@@@@@@@@@@@@%%####@+=+**#*++===+*####*+=+*#%@@@%#**#....................-+:::+
.................:@@@@@@@@@@@@@@@@@@%@@#@#%%##**++++***+==*****#%%#@@@%#*#.................:.+:.=***
............. ....@@@%%@@@@@@@@@@@@@@@%@@#########**===***##%######@@@####........................-*
:..................@@@@@@@@@@@@@@@@@@%%###****+++*#=##+###****+**#%@@@%%***.........................
...................#@@@@@@@@%@@@@@@@@@@%#@*#%#++#%###+===+###%##%%@@@@%%###+...................:....
....................#@@@@@@@@@@@@@@@@%%@%%++@@%####*=#@%####****@@@@@@@%###=:.......................
..................   %@@@@@@@@@@@@@@@#*#%@@%%##+==%@##%@%%%%@%%@@@@@@@###+*#-..............:........
.......            ...%@@@@@@@@@@@@@@%@@@@***#%@@#***###%%@@%%%#@@@@@@*%@@%%#..................::::.
.......            ....@@@@@@@@@@@@%%@%%%@%%%%###%%##%%%@@%@@@@@@@@@@@@%+*#**.................::::::
.........            ..:@@@@@@%########%%%#************####@@@#%@@@@@%@%**++*-...................:::
.........            ...@@@@@%#######**%%%**#**************%%@#%@@@@@##%%++=+*.............:.::.::::
..........         ....:@@@@@%%%##*###*%%%*##***********###@@@#%@@@@@@@%%#****+...............-+-+=+
..........         .=@@@%@@%@@*@@@##%%%@@@@%%%%%%%#########%@@#@#%%@%@@@%%#*+**....................-
..........   ....  .%@@@%@@@@@#@@@@@@@@@@@@@@@@%#@@#@@*#@@@@@@@@@@@@%@@%%*+*#%@@=...................
...........        .@@@%@@@@@@#@@@@@@@@@@@@@@@@%@@#*#@@#@@@@@@@@@@@@%@@@%***#%@@-.................::
...........        .@@@%%@@@@%@@@@@@@@@@@%@@@@@%@%####@%@@@@@@@@@@@@@@@@%#**#%@@@...........=++.++:-
..:........       ..%@@%%@@@@@@@@@@@@@@@@@@%@@@%#@@@@@#%@@@@@@@@@@@@@@@@@%***#%@@................--*
.....:++...       ..@@@%%@@@@@@@@%##*#***********##*********##@@@@@@@@@@@%%***#@@:................:.
...........        .%@@%%@@@@@@@@@%%########%%%###############%@@@%@@@@@@@@#**#@@%..................
...........       ..:@@@@@@@@@@@@%@%@@@@@%%##***##%#******###%%@@@@@@@@@@@@@@*+%@@..............::-:
....... ......... ....+@@@@@@@@%%#####*****++++++*#******###%%%%@@@@@@@@@@@@@###%@*.............:---
......... ... ... ....*@@@@@@@@@@@@@%%%%%%%#%####%%###*+**###%%%%@@@.@@@@@@@@@%%%@@..........:::.:::
.............     ....%@@@@@@%%%%#######**********%###******##%%%%%@-.%@@@@@@%%%@%@@.........:*++**+
.............    .....@%@@%@@@@%%%%%%############%%##############%@@@...@@@@@@@@%#%@%@@@%........:+*
...........      .. ..@@@@@@%%%%%##########################*######%@@....%@@@@*++#@@@%@@##-....::::=
......             ..%@@@%%#%%%%%%###%##%%%#%%%%@@@##############%@@@%.  .#@@%@%##@%@@%@@##......::*
......             .:@@@%%%%%%%##########%%%%%###%%#******####%%%%%@@@.....@@@@@@%%@%@@%@@%%.....:-+
:-...  ........  ...@@@%###%%%%%##############%%%%%#######%#######%%@@:..  .@@@@@%#@@@@@%@%%*....:-+
-+...  ... ....  ..-@@@@@@%%############%%%%%%%%%%%################%%@#......@@@@%%@@%@@@@@#%..:....
:......   .....  ..@@@@@%%#############%%%%%%%%%@@%%#%###%%%#####%##%@@@@@@=..@@@%@@@%%@@#@@%%=+*=:.
.......   .....  .@@@%@@@%%%%%#####%%%%%%%%%%%%%@@%%%%%%%%%%########%%@@@@@@..@@@@@@@@@@@@%@#%#::=*=
.................:@@@@@@%%%%#####%%%%%%%%%%%%%%@@@@@@@@@@%%#######%#%%@@@@@@:.#@@@%@@%@@@%%@@#%:::*+
.................%@@@@%%%%#####%%%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%#####%@%@@@@@@.%@@@@@@@@%@@%%@%%%:::=
.................@@@@@%%####%%%%%%%%%%%%%%%%@@@@@@@@@@@@%%%%%%####@%@@@@@@@@@+.....=@@@@@@@@@@@@:.::
................*@@@@%%%%##%%%%%%%%%%%%%%%%@@@@-@@@@@@@@@@%%%%%@@@@@@@@@@@@@@+......##@@@@@@@@@+-:-:
................@@%@%%%%#%%%%%%%%%%%%%%%%@@@@@..-@@@@@@@@@@@@@@@@@@@@@@@@@@@@... .....#%@@@@%@******
...............*@@@%%%%%%%%%%%%%%%%%%%%%@@@@@...:@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.........%@@@%@@*++***
...............@@@%%%%%%%%%%%%%%%%%%%%%@@@@@.....@@@@@@@@@@@@@@@@@@%@@@%%@@@@@.........:.+-+@%@:::-*
............=::@@@%%%#%%%%%%%%%%%%%%%%@@@@@....  =@@@@@@@@@@@%%%%%%#%%%%%@@@@@:.....-:...:=*%@#@*=-:
.....:=-+=.+=.%@@@%%%%%%%%%%%%%%%%%%@@@@@@.....  .@@@@@@@@@@@@%%%%%%%%%%%%@@@@@.....=+*+:..::@@%#+=:
-::::**++=....@@@@%%%%%%%%%%%%%%%%@@@@@@@:........=@@@@@@@@@@@%%%%%%%%%%%%@@@%@*.....****=:...@@@#+:
*+.::**--....=@@@%%%%%%%%%%%%%%%%@@@@@@@-...........@@@@@@@@@@@%%%%%%@%@@@@@@@@@..==+:+#***-=:%@*@**
-:.:....:....#@@@%%%%%%%%%%%%@@@@%@@@@@-............*@@@@@@@@@@@@@@@@@@@@@@@@@@@..::..:-+*****:@@%%*
::.:........=@@@@%%%%%%%%%%@@@@@@@@@@@:..............@@@@@@@@@@@@@@@@@@@@@@@@@@@+=:..::.:--*********
:::=--......+@%%%%%%%%%%@@@@@@@@@@@@@-................@@@@@@@@@@@@@@@@@@@@@@@@@@+-:::::::::-********

              All Hail Cobra Commander, The Great Snake Rules Forever!
''')
        sys.exit(0)

    if len(sys.argv) != 3 or sys.argv[1] not in ('encrypt', 'decrypt'):
        print_help()
        sys.exit(1)

    command = sys.argv[1]
    target_dir = sys.argv[2]

    if not os.path.isdir(target_dir):
        print(f"Error: '{target_dir}' is not a valid directory.")
        sys.exit(1)

    password = getpass("Enter COBRA clearance password: ")

    if command == 'encrypt':
        encrypt_directory(target_dir, password)
    elif command == 'decrypt':
        decrypt_directory(target_dir, password)
